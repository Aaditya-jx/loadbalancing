# AI-Powered Secure Load Balancer Makefile

.PHONY: help setup train build run stop clean test logs dashboard traffic

# Default target
help:
	@echo "AI-Powered Secure Load Balancer - Available Commands:"
	@echo ""
	@echo "setup      - Install dependencies and train AI model"
	@echo "train      - Train the AI intrusion detection model"
	@echo "build      - Build Docker images"
	@echo "run        - Start all services with Docker"
	@echo "dev        - Start development environment"
	@echo "stop       - Stop all services"
	@echo "clean      - Clean up Docker resources"
	@echo "test       - Run tests and generate traffic"
	@echo "logs       - Show logs from all services"
	@echo "dashboard  - Open dashboard in browser"
	@echo "traffic    - Generate test traffic"

# Setup project
setup:
	@echo "ğŸš€ Setting up AI-Powered Secure Load Balancer..."
	@mkdir -p logs data models config
	@pip install -r requirements.txt
	@$(MAKE) train
	@echo "âœ… Setup completed!"

# Train AI model
train:
	@echo "ğŸ¤– Training AI intrusion detection model..."
	@cd ai_model && python train_model.py
	@echo "âœ… Model training completed!"

# Build Docker images
build:
	@echo "ğŸ³ Building Docker images..."
	@docker-compose build
	@echo "âœ… Build completed!"

# Run production services
run:
	@echo "ğŸš€ Starting production services..."
	@docker-compose up --build -d
	@echo "âœ… Services started!"
	@echo "Load Balancer: http://localhost:8000"
	@echo "Dashboard: http://localhost:5000"

# Run development services
dev:
	@echo "ğŸ”§ Starting development services..."
	@docker-compose -f docker-compose.dev.yml up --build -d
	@echo "âœ… Development services started!"
	@echo "Load Balancer: http://localhost:8000"
	@echo "Dashboard: http://localhost:5000"

# Stop services
stop:
	@echo "ğŸ›‘ Stopping services..."
	@docker-compose down
	@docker-compose -f docker-compose.dev.yml down 2>/dev/null || true
	@echo "âœ… Services stopped!"

# Clean up
clean:
	@echo "ğŸ§¹ Cleaning up..."
	@docker-compose down -v
	@docker-compose -f docker-compose.dev.yml down -v 2>/dev/null || true
	@docker system prune -f
	@docker volume prune -f
	@echo "âœ… Cleanup completed!"

# Run tests
test:
	@echo "ğŸ§ª Running tests..."
	@$(MAKE) traffic
	@echo "âœ… Tests completed!"

# Generate traffic
traffic:
	@echo "ğŸš¦ Generating test traffic..."
	@docker-compose --profile testing up traffic-generator --build

# Show logs
logs:
	@echo "ğŸ“‹ Showing logs..."
	@docker-compose logs -f

# Dashboard logs
dashboard-logs:
	@echo "ğŸ“Š Dashboard logs..."
	@docker-compose logs -f dashboard

# Load balancer logs
lb-logs:
	@echo "âš–ï¸ Load balancer logs..."
	@docker-compose logs -f load-balancer

# Server logs
server-logs:
	@echo "ğŸ–¥ï¸ Server logs..."
	@docker-compose logs -f backend-server-1 backend-server-2 backend-server-3

# Open dashboard
dashboard:
	@echo "ğŸŒ Opening dashboard..."
	@python -c "import webbrowser; webbrowser.open('http://localhost:5000')" 2>/dev/null || echo "Please open http://localhost:5000 in your browser"

# Health check
health:
	@echo "ğŸ¥ Checking service health..."
	@curl -f http://localhost:8000/health || echo "âŒ Load balancer not healthy"
	@curl -f http://localhost:5000/api/health || echo "âŒ Dashboard not healthy"
	@curl -f http://localhost:8001/health || echo "âŒ Server 1 not healthy"
	@curl -f http://localhost:8002/health || echo "âŒ Server 2 not healthy"
	@curl -f http://localhost:8003/health || echo "âŒ Server 3 not healthy"

# Metrics
metrics:
	@echo "ğŸ“Š System metrics:"
	@curl -s http://localhost:8000/metrics | python -m json.tool || echo "âŒ Could not fetch metrics"

# Quick test
quick-test:
	@echo "âš¡ Quick test..."
	@echo "Testing normal request..."
	@curl -w "Time: %{time_total}s\n" -s http://localhost:8000/api/users > /dev/null
	@echo "Testing security..."
	@curl -w "Time: %{time_total}s\n" -s "http://localhost:8000/api/users?id=1' OR '1'='1" > /dev/null
	@echo "âœ… Quick test completed!"

# Performance test
perf-test:
	@echo "ğŸš€ Performance test..."
	@echo "Testing 1000 requests..."
	@if command -v ab >/dev/null 2>&1; then \
		ab -n 1000 -c 10 http://localhost:8000/api/users; \
	else \
		echo "Apache Bench (ab) not found. Install it for performance testing."; \
	fi

# Development setup (local)
dev-setup:
	@echo "ğŸ”§ Setting up local development environment..."
	@mkdir -p logs data models
	@pip install -r requirements.txt
	@echo "âœ… Local development setup completed!"
	@echo "Run './start_servers.sh' to start backend servers"
	@echo "Run './start_load_balancer.sh' to start load balancer"
	@echo "Run './start_dashboard.sh' to start dashboard"

# Full reset
reset: clean
	@echo "ğŸ”„ Full reset..."
	@rm -rf logs/* data/* models/*
	@mkdir -p logs data models
	@$(MAKE) setup
	@echo "âœ… Full reset completed!"

# Backup data
backup:
	@echo "ğŸ’¾ Backing up data..."
	@tar -czf backup-$(shell date +%Y%m%d-%H%M%S).tar.gz logs/ data/ models/
	@echo "âœ… Backup completed!"

# Development server (local)
dev-servers:
	@echo "ğŸ–¥ï¸ Starting local development servers..."
	@cd servers && python server1.py & \
	cd servers && python server2.py & \
	cd servers && python server3.py & \
	echo "âœ… Servers started in background"

# Development load balancer (local)
dev-lb:
	@echo "âš–ï¸ Starting local development load balancer..."
	@cd load_balancer && python load_balancer.py

# Development dashboard (local)
dev-dashboard:
	@echo "ğŸ“Š Starting local development dashboard..."
	@cd dashboard && python app.py

# Install development tools
install-tools:
	@echo "ğŸ› ï¸ Installing development tools..."
	@pip install black flake8 pytest pytest-cov
	@echo "âœ… Development tools installed!"

# Code formatting
format:
	@echo "ğŸ¨ Formatting code..."
	@black ai_model/ load_balancer/ servers/ traffic/ dashboard/
	@echo "âœ… Code formatted!"

# Linting
lint:
	@echo "ğŸ” Linting code..."
	@flake8 ai_model/ load_balancer/ servers/ traffic/ dashboard/ --max-line-length=100
	@echo "âœ… Linting completed!"

# Run all checks
check: format lint test
	@echo "âœ… All checks completed!"
