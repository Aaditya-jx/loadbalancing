{% extends "base.html" %}

{% block title %}Analytics - AI-Powered Secure Load Balancer{% endblock %}

{% block content %}
<div class="row g-4 p-4">
    <!-- Header -->
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h1 class="h2 mb-0">
                            <i class="fas fa-chart-line text-primary me-3"></i>
                            Advanced Analytics
                        </h1>
                        <p class="text-muted mb-0">Detailed traffic analysis and performance metrics</p>
                    </div>
                    <div class="col-md-4 text-end">
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-primary" onclick="changeTimeRange('1h')">1H</button>
                            <button type="button" class="btn btn-outline-primary" onclick="changeTimeRange('24h')">24H</button>
                            <button type="button" class="btn btn-outline-primary active" onclick="changeTimeRange('7d')">7D</button>
                            <button type="button" class="btn btn-outline-primary" onclick="changeTimeRange('30d')">30D</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Key Performance Indicators -->
    <div class="col-md-3">
        <div class="card stat-card">
            <div class="card-body text-center">
                <div class="metric-value" id="total-traffic">-</div>
                <div class="metric-label">Total Traffic</div>
                <div class="mt-2">
                    <i class="fas fa-network-wired fa-2x"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card stat-card" style="background: linear-gradient(135deg, #3b82f6, #1d4ed8);">
            <div class="card-body text-center">
                <div class="metric-value" id="peak-requests">-</div>
                <div class="metric-label">Peak Requests/sec</div>
                <div class="mt-2">
                    <i class="fas fa-rocket fa-2x"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card stat-card" style="background: linear-gradient(135deg, #10b981, #059669);">
            <div class="card-body text-center">
                <div class="metric-value" id="avg-latency">-</div>
                <div class="metric-label">Avg Latency (ms)</div>
                <div class="mt-2">
                    <i class="fas fa-clock fa-2x"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card stat-card" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
            <div class="card-body text-center">
                <div class="metric-value" id="error-rate">-</div>
                <div class="metric-label">Error Rate %</div>
                <div class="mt-2">
                    <i class="fas fa-exclamation-triangle fa-2x"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Traffic Analysis Charts -->
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-chart-area me-2"></i>
                    Traffic Analysis
                </h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="trafficAnalysisChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="fas fa-chart-pie me-2"></i>
                    Protocol Distribution
                </h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="protocolChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Performance Metrics -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                    <i class="fas fa-tachometer-alt me-2"></i>
                    Response Time Distribution
                </h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="responseTimeChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-warning text-white">
                <h5 class="mb-0">
                    <i class="fas fa-server me-2"></i>
                    Server Load Distribution
                </h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="serverLoadChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Attack Pattern Analysis -->
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0">
                    <i class="fas fa-shield-alt me-2"></i>
                    Attack Pattern Analysis
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <div class="chart-container">
                            <canvas id="attackPatternChart"></canvas>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <h6>Attack Statistics</h6>
                        <div id="attack-stats">
                            <div class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Geographic Distribution -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0">
                    <i class="fas fa-globe me-2"></i>
                    Geographic Distribution
                </h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="geoChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-calendar me-2"></i>
                    Hourly Traffic Pattern
                </h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="hourlyPatternChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let trafficAnalysisChart, protocolChart, responseTimeChart, serverLoadChart, attackPatternChart, geoChart, hourlyPatternChart;
let currentTimeRange = '7d';

// Initialize analytics page
document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();
    loadAnalyticsData();
    setInterval(loadAnalyticsData, 10000); // Refresh every 10 seconds
});

function initializeCharts() {
    // Traffic Analysis Chart
    const trafficCtx = document.getElementById('trafficAnalysisChart').getContext('2d');
    trafficAnalysisChart = new Chart(trafficCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Incoming Requests',
                data: [],
                borderColor: '#3b82f6',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                fill: true,
                tension: 0.4
            }, {
                label: 'Blocked Attacks',
                data: [],
                borderColor: '#ef4444',
                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                fill: true,
                tension: 0.4
            }, {
                label: 'Successful Requests',
                data: [],
                borderColor: '#10b981',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    stacked: true
                }
            }
        }
    });

    // Protocol Distribution Chart
    const protocolCtx = document.getElementById('protocolChart').getContext('2d');
    protocolChart = new Chart(protocolCtx, {
        type: 'doughnut',
        data: {
            labels: ['HTTP', 'HTTPS', 'TCP', 'UDP'],
            datasets: [{
                data: [65, 25, 7, 3],
                backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });

    // Response Time Distribution Chart
    const responseCtx = document.getElementById('responseTimeChart').getContext('2d');
    responseTimeChart = new Chart(responseCtx, {
        type: 'bar',
        data: {
            labels: ['0-50ms', '50-100ms', '100-200ms', '200-500ms', '500ms+'],
            datasets: [{
                label: 'Request Count',
                data: [45, 30, 15, 7, 3],
                backgroundColor: '#3b82f6'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // Server Load Chart
    const serverLoadCtx = document.getElementById('serverLoadChart').getContext('2d');
    serverLoadChart = new Chart(serverLoadCtx, {
        type: 'radar',
        data: {
            labels: ['Server 1', 'Server 2', 'Server 3'],
            datasets: [{
                label: 'Current Load',
                data: [65, 45, 80],
                borderColor: '#3b82f6',
                backgroundColor: 'rgba(59, 130, 246, 0.2)'
            }, {
                label: 'Capacity',
                data: [100, 100, 100],
                borderColor: '#e5e7eb',
                backgroundColor: 'rgba(229, 231, 235, 0.2)'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                r: {
                    beginAtZero: true,
                    max: 100
                }
            }
        }
    });

    // Attack Pattern Chart
    const attackPatternCtx = document.getElementById('attackPatternChart').getContext('2d');
    attackPatternChart = new Chart(attackPatternCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'SQL Injection',
                data: [],
                borderColor: '#ef4444',
                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                tension: 0.4
            }, {
                label: 'XSS',
                data: [],
                borderColor: '#f59e0b',
                backgroundColor: 'rgba(245, 158, 11, 0.1)',
                tension: 0.4
            }, {
                label: 'Path Traversal',
                data: [],
                borderColor: '#8b5cf6',
                backgroundColor: 'rgba(139, 92, 246, 0.1)',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                }
            }
        }
    });

    // Geographic Chart
    const geoCtx = document.getElementById('geoChart').getContext('2d');
    geoChart = new Chart(geoCtx, {
        type: 'bar',
        data: {
            labels: ['North America', 'Europe', 'Asia', 'South America', 'Africa', 'Oceania'],
            datasets: [{
                label: 'Requests',
                data: [35, 28, 20, 8, 5, 4],
                backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // Hourly Pattern Chart
    const hourlyCtx = document.getElementById('hourlyPatternChart').getContext('2d');
    hourlyPatternChart = new Chart(hourlyCtx, {
        type: 'bar',
        data: {
            labels: Array.from({length: 24}, (_, i) => `${i}:00`),
            datasets: [{
                label: 'Normal Traffic',
                data: [20, 15, 10, 8, 12, 25, 45, 65, 78, 85, 90, 88, 82, 75, 70, 68, 72, 78, 82, 75, 60, 45, 30],
                backgroundColor: '#10b981'
            }, {
                label: 'Attack Traffic',
                data: [5, 3, 2, 2, 3, 8, 15, 25, 28, 30, 32, 30, 28, 25, 22, 20, 22, 25, 28, 25, 20, 15, 10, 8],
                backgroundColor: '#ef4444'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    stacked: true
                }
            }
        }
    });
}

function changeTimeRange(range) {
    currentTimeRange = range;
    
    // Update button states
    document.querySelectorAll('.btn-group button').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // Reload data with new time range
    loadAnalyticsData();
}

async function loadAnalyticsData() {
    try {
        // Simulate loading different data based on time range
        const multiplier = currentTimeRange === '1h' ? 1 : 
                          currentTimeRange === '24h' ? 24 : 
                          currentTimeRange === '7d' ? 168 : 720;
        
        // Update KPIs
        document.getElementById('total-traffic').textContent = (Math.random() * 50000 * multiplier + 10000).toFixed(0);
        document.getElementById('peak-requests').textContent = (Math.random() * 200 + 50).toFixed(0);
        document.getElementById('avg-latency').textContent = (Math.random() * 50 + 20).toFixed(0);
        document.getElementById('error-rate').textContent = (Math.random() * 2 + 0.5).toFixed(2);
        
        // Update attack statistics
        updateAttackStats();
        
        // Generate time-based data for charts
        const timeLabels = generateTimeLabels(currentTimeRange);
        updateChartsWithData(timeLabels, multiplier);
        
    } catch (error) {
        console.error('Error loading analytics data:', error);
    }
}

function generateTimeLabels(range) {
    const labels = [];
    const now = new Date();
    
    if (range === '1h') {
        for (let i = 0; i < 12; i++) {
            labels.push(new Date(now.getTime() - (11 - i) * 5 * 60000).toLocaleTimeString());
        }
    } else if (range === '24h') {
        for (let i = 0; i < 24; i++) {
            labels.push(`${i}:00`);
        }
    } else if (range === '7d') {
        for (let i = 0; i < 7; i++) {
            labels.push(new Date(now.getTime() - (6 - i) * 24 * 60000).toLocaleDateString());
        }
    } else {
        for (let i = 0; i < 30; i++) {
            labels.push(new Date(now.getTime() - (29 - i) * 24 * 60000).toLocaleDateString());
        }
    }
    
    return labels;
}

function updateChartsWithData(labels, multiplier) {
    // Update traffic analysis chart
    const normalData = labels.map(() => Math.random() * 1000 * multiplier + 500);
    const attackData = labels.map(() => Math.random() * 100 * multiplier + 10);
    const successData = labels.map(() => Math.random() * 900 * multiplier + 400);
    
    trafficAnalysisChart.data.labels = labels;
    trafficAnalysisChart.data.datasets[0].data = normalData;
    trafficAnalysisChart.data.datasets[1].data = attackData;
    trafficAnalysisChart.data.datasets[2].data = successData;
    trafficAnalysisChart.update();
    
    // Update attack pattern chart
    const sqlData = labels.map(() => Math.random() * 50 * multiplier + 5);
    const xssData = labels.map(() => Math.random() * 30 * multiplier + 3);
    const traversalData = labels.map(() => Math.random() * 20 * multiplier + 2);
    
    attackPatternChart.data.labels = labels;
    attackPatternChart.data.datasets[0].data = sqlData;
    attackPatternChart.data.datasets[1].data = xssData;
    attackPatternChart.data.datasets[2].data = traversalData;
    attackPatternChart.update();
}

function updateAttackStats() {
    const statsHtml = `
        <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center">
                <span>Total Attacks Blocked:</span>
                <strong>${(Math.random() * 1000 + 500).toFixed(0)}</strong>
            </div>
        </div>
        <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center">
                <span>Most Common Attack:</span>
                <strong>SQL Injection</strong>
            </div>
        </div>
        <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center">
                <span>Attack Success Rate:</span>
                <strong>${(Math.random() * 5 + 2).toFixed(1)}%</strong>
            </div>
        </div>
        <div>
            <div class="d-flex justify-content-between align-items-center">
                <span>Avg Detection Time:</span>
                <strong>${(Math.random() * 50 + 10).toFixed(0)}ms</strong>
            </div>
        </div>
    `;
    
    document.getElementById('attack-stats').innerHTML = statsHtml;
}
</script>
{% endblock %}
