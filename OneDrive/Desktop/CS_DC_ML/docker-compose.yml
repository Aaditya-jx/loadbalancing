version: '3.8'

services:
  # AI Model Training Service
  ai-model:
    build:
      context: .
      target: model-trainer
    container_name: ai-model-trainer
    volumes:
      - ./models:/app/models
      - ./data:/app/data
      - ./logs:/app/logs
    environment:
      - PYTHONPATH=/app
    networks:
      - secure-lb-network
    profiles:
      - training

  # Load Balancer Service
  load-balancer:
    build:
      context: .
      target: load-balancer
    container_name: secure-load-balancer
    ports:
      - "8000:8000"
    volumes:
      - ./models:/app/models
      - ./logs:/app/logs
      - ./data:/app/data
    environment:
      - PYTHONPATH=/app
      - LB_HOST=0.0.0.0
      - LB_PORT=8000
      - ENABLE_AI_SECURITY=true
      - BLOCK_MALICIOUS_REQUESTS=true
      - DB_TYPE=sqlite
      - SQLITE_DB_PATH=/app/logs/load_balancer.db
      - MODEL_CONFIDENCE_THRESHOLD=0.7
      - LB_ALGORITHM=least_connections
      - HEALTH_CHECK_INTERVAL=30
    depends_on:
      - backend-server-1
      - backend-server-2
      - backend-server-3
    networks:
      - secure-lb-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Backend Server 1
  backend-server-1:
    build:
      context: .
      dockerfile: servers/Dockerfile.server1
    container_name: backend-server-1
    ports:
      - "8001:8001"
    environment:
      - PYTHONPATH=/app
      - SERVER_ID=server-1
      - SERVER_PORT=8001
    networks:
      - secure-lb-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Backend Server 2
  backend-server-2:
    build:
      context: .
      dockerfile: servers/Dockerfile.server2
    container_name: backend-server-2
    ports:
      - "8002:8002"
    environment:
      - PYTHONPATH=/app
      - SERVER_ID=server-2
      - SERVER_PORT=8002
    networks:
      - secure-lb-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8002/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Backend Server 3
  backend-server-3:
    build:
      context: .
      dockerfile: servers/Dockerfile.server3
    container_name: backend-server-3
    ports:
      - "8003:8003"
    environment:
      - PYTHONPATH=/app
      - SERVER_ID=server-3
      - SERVER_PORT=8003
    networks:
      - secure-lb-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8003/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Dashboard Service
  dashboard:
    build:
      context: .
      dockerfile: dashboard/Dockerfile
    container_name: secure-lb-dashboard
    ports:
      - "5000:5000"
    volumes:
      - ./logs:/app/logs
    environment:
      - PYTHONPATH=/app
      - DB_PATH=/app/logs/load_balancer.db
    depends_on:
      - load-balancer
    networks:
      - secure-lb-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  # Traffic Generator (for testing)
  traffic-generator:
    build:
      context: .
      dockerfile: traffic/Dockerfile
    container_name: traffic-generator
    environment:
      - LOAD_BALANCER_URL=http://load-balancer:8000
      - PYTHONPATH=/app
    depends_on:
      - load-balancer
    networks:
      - secure-lb-network
    profiles:
      - testing
    command: ["python", "wait_for_lb.py", "&&", "python", "traffic_generator.py"]

  # Streamlit Dashboard Service
  streamlit-dashboard:
    build:
      context: .
      dockerfile: streamlit/Dockerfile
    container_name: streamlit-dashboard
    ports:
      - "8501:8501"
    environment:
      - PYTHONPATH=/app
    networks:
      - secure-lb-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8501/_stcore/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  # Nginx Reverse Proxy (optional)
  nginx:
    image: nginx:alpine
    container_name: nginx-proxy
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./nginx/ssl:/etc/nginx/ssl
    depends_on:
      - load-balancer
      - dashboard
    networks:
      - secure-lb-network
    restart: unless-stopped
    profiles:
      - production

networks:
  secure-lb-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

volumes:
  models:
    driver: local
  logs:
    driver: local
  data:
    driver: local
